<!DOCTYPE html>
<html>

<head>
	<base target="_top" />
</head>

<body>

	<head>
		<style>
			:root {
  --main: #ffbf00;
  --greyed: #664d00;
}
			html,
			body {
				margin: 0;
				overflow: hidden;
				height: 100vh;
			}

			.statement {
				overflow-y: scroll;
				height: 100vh;
				box-shadow: -10px 0px 10px 0px rgba(0, 0, 0, 0.2);
				width: fit-content;
				transition: width 3s;
			}

			.statement tr:hover {
				background-color: #f2f2f2;
			}

			.marked-row,
			#email ,#bal{
				background-color: yellow;
				color: black;
				margin: 0;
			}

			.filter-multi-select.dropdown {
				width: fit-content;

			}

			#email,#bal {
				width: fit-content;
				display: inline
			}

			.t,.t td,.t th {
				border: 1px black solid;
				
				width: fit-content;
				border-spacing: 0;
			}
			.t{
				border-collapse: collapse;
        border-radius: 5px;
        border-style: hidden; /* hide standard table (collapsed) border */
        box-shadow: 0 0 0 1px #666; /* this draws the table border  */ 
		    margin-top: 1%;
    margin-bottom: 1%;
			}

			.t input {
				width: 100%;
			}

			
			.t,
			.s {
				display: none;
			}

			.m {
				margin: auto;
				width: fit-content;
				height: fit-content;
				background-color: #fdfdfd;
				border-radius: 5%;
				padding: 3vw;
				box-shadow: 0 4px 8px 0 #00000033, 0 6px 20px 0 #00000030;
				position: relative;
			}

			.s {
				float: right;
				background-color: #ffbf00;
				color: white;
				border: none;
				border-radius: 1.1em;
				padding: 0px .5em 0 .5em;
			}

			.s:hover {
				cursor: pointer;
			}

			main {
				display: flex !important;
				flex-direaction: row;
				width: 100%;
				height: 100vh;
			}

			.statement thead th {
				position: sticky;
				top: 0;
				background-color: #f2f2f2;
				cursor: pointer;
			}

			.statement thead th i {
				vertical-align: middle;
			}

			.h {
				display: none;
			}

			.reciept p {
				display: inline
			}



			.v{background: none;
	color: inherit;
	border: none;
	padding: 0;
	font: inherit;
	cursor: pointer;
	margin: 0;
	outline: inherit;}

.v::before {
	content: ">";
    display: inline-block;
    transition: transform 0.3s ease;
    cursor: pointer;
    font-size: 16px;
    margin: 0;
    padding: 0;
    position: absolute;
    z-index: 10;
    background-color: #a8a8a8;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    transform: translate(-50%, -50%);
    top: 50vh;
    text-align: center;
	box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
	transition: width 3s;
	font-weight: bold;
}
	.v:hover::before{
background-color: #7b7b7b;
}
.v.collapsed::before {
  transform: rotate(90deg);
}
.statement.collapsed{
	
}
.v.collapsed::before{
	position: absolute;
	top: 50%;
	right:0px;
	transform: translate(-50%, -50%);
	content: "<";

}
.filter-multi-select{
		width: 100%!important;
	}
	.dropdown{
		width: 100%;
	}
	.t{
		width: 100%;
	}
	
	.t input{
		/*width: 100%;*/
	}
	#his{
text-decoration: underline;
float: right;
line-height: 3;
	}
	.in{
		display:grid;
    grid-template-columns: max-content auto;
	align-items: center;
	justify-items: start;
	}
	.statement td:nth-child(3) ,.statement th:nth-child(3) {display: none;}
	#his i{font-size: medium;}
	h1 i{font-size: smaller;}
	label{margin: 0;}
	#titleInput{width: 100%;}
	div.filter.dropdown-item{
		position: fixed;
    background-color: white;
    z-index: 10;
	margin-left: 20px;
	margin-right: 20px;
		width: auto;
	}
	div.dropdown-menu.show{
		padding-top: 10px;
	}
	.filter-multi-select .dropdown-item {
    width: 10vw;
}
.filter{
	padding: 0!important;
	transform: translate(0,-5px);
}
.filter-multi-select > .dropdown-menu > .filter > button {
    top: 0.3rem!important;
    right: 0.5rem!important;

}
/*element.style {
    transform: translate(290px, -50px);
}*/

.dropdown-menu{
	max-height: 25vh!important;
	width: 20vw;
	
}
#deb{
	width: 100%;
}
input{
	border: none!important;
      border:solid 1px #ccc!important;
      border-radius: 10px!important;
}
hr {
  width: 16px!important;
  height: 16px!important;
  border: 4px solid #ccc!important;
  border-top-color: #000!important;
  border-radius: 50%!important;
  animation: spin 1s infinite linear!important;
}
.s p{
	margin: 0;
}
.l .s p{
display: none;
}

@keyframes spin {
  0% {transform: rotate(0deg);}
  100% {transform: rotate(360deg);}
}
.s hr{
	display: none;
}
.l .s hr{
	display: block;
}
span.item{
	background-color: var(--main)!important;
}
.s:disabled,.s[disabled] {
  opacity: 0.6;
  cursor: not-allowed!important;
}
@media only screen and (max-width: 700px){
							.v.collapsed::before{
								z-index: 15;
								left:0;
								transform: none;
								content: ">";}
							.v::before {
								right: 0;
								content: "<";}
							.statement{display: none;}
							.statement.collapsed{
								overflow-y: scroll;
								height: 100vh;
								width: 100vw;
								position: absolute;
								top: 0;
								left: 0;
								background-color: white;	
								display: block;}
								.statement.collapsed table{
							width: 100vw;
								}
}/*mobile*/
		</style>
	</head>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" rel="stylesheet" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
	<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<script src="https://momentjs.com/downloads/moment.min.js"></script>

	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/gh/andreww1011/filter-multi-select/dist/filter_multi_select.css" />
	<script
		src="https://cdn.jsdelivr.net/gh/andreww1011/filter-multi-select/dist/filter-multi-select-bundle.min.js"></script>
	<main>
		<div class=m>
			<h1 style="display: inline;margin-right: 3vw;"><span class="material-symbols-outlined">wallet</span>&nbsp;Lunch Balance</h1>
			<a href="javascript:void(0)" onclick="window.open('https://docs.google.com/spreadsheets/d/1pU4uWo6HQUNyoJ5C7ZLx-tJ1Pk0Vvxsmgc04hw0UWtw/edit#gid=205375985')" id=his>View History <i class=material-symbols-outlined>open_in_new</i></a>

				
			<aside class=in>
			
			<label for=email>Your are:</label><p id=email><?=grab('user')?></p>
			<label for=bal>Balance:</label>	<p id=bal></p>
			<label for=titleInput>Restaurant (Optional):</label><input id=titleInput>
			<label for=deb style=align-self:normal>Debitor(s):</label>
			<div id=deb>
			<select multiple id="debitors" name="debitor" style="display:none"></select>
			<table class=t>
				<thead>
					<tr>
						<th>Debitor(s)</th>
						<th>Amount</th>
					</tr>
				</thead>
				<tbody class=distribute></tbody>
				<tfoot>
					<tr>
						<td>Total</td>
						<td>0</td>
					</tr>
				</tfoot>
			</table>
			</div><!--id deb-->
			<i></i>
			<button class=s disabled> <hr><p>Submit</p></button>

			<aside class='reciept h'>
				<table>
					<thead>
						<tr>
							<td colspan=3>Lunch Balance Reciept</td>
						</tr>
						<tr>
							<td>Title:</td>
							<td colspan=2 class=titleOutput></td>
						</tr>
						<tr>
							<td>Payer:</td>
							<td colspan=2 class=payer></td>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</aside>
			</aside>
			<aside class=out></aside>

		</div><!--close m-->

		<div><p class=v></p><div class=statement></div></div><!--<button class=v></button>-->
	</main>
	<script>
		//put data in div
		var select
		function initStatement() {
			$('.statement tbody tr').each(function () {if ($(this).find('td:nth-child(3)').text() === user) $(this).addClass('marked-row')})
			$('.statement th').each(function () { $(this).html($(this).html() + '<i class="material-icons" style="vertical-align: middle">unfold_more</i>') });
		}
		function lookup(input, inputColumn, outputColumn) {//0,1,2
			$('.statement tbody tr').each(function () {
				if ($(this).find(`td:eq(${inputColumn})`).text() === input) result = $(this).find(`td:eq(${outputColumn})`).text();
			});
			return result;
		}


		var c='<?=cache()?>'
		if (c) {
			console.log('got from gas',c)
			console.log('cache',c.recentD)
			
		}
		else {
	c={}
	c.recentD=['stang@peplink.com']
	google.script.run.withSuccessHandler(cache => {console.log('cache', cache)}).cache(c)
console.log('c.recentD',c.recentD)
	}
		google.script.run.withSuccessHandler(cache => {console.log('cache', cache)}).cache()



			$('.statement').html(<?=grab('table')?>).promise().done(function () {
		
				user=<?=grab('user')?>;
					initStatement()
					$('.v').click(()=>{$('.v,.statement').toggleClass('collapsed');$('.statement').toggle("slide", {direction:'right'})})
					$(document).on('click', '.statement thead th', function () {
						table = $(this).closest('.statement');
						columnIndex = $(this).index();
						rows = table.find('tbody tr').get();
						ascending = $(this).data('ascending');
						$('.statement i').html('unfold_more')
						$(this).find('i').html(ascending ? 'keyboard_arrow_up' : 'keyboard_arrow_down');
						rows.sort(function (a, b) {
							aValue = $(a).find('td').eq(columnIndex).text();
							bValue = $(b).find('td').eq(columnIndex).text();
							if (!isNaN(parseFloat(aValue)) && !isNaN(parseFloat(bValue))) {
								aValue = parseFloat(aValue.replace(',', '')) || 0;
								bValue = parseFloat(bValue.replace(',', '')) || 0;
								return ascending ? (aValue - bValue) : (bValue - aValue);
							} else if (aValue === bValue) return 0;
							else return ascending ? (aValue.localeCompare(bValue)) : (bValue.localeCompare(aValue));
						});

						$(this).data('ascending', !ascending);
						table.find('tbody').empty().append(rows);
					});

					$('#bal').html(lookup(user,2,1))
					$('.statement tbody tr').each(function () {
						$('#debitors').append('<option value="' + $(this).find('td:nth-child(3)').text()+ '">' + $(this).find('td:first').text() + '</option>')
					}).promise().done(function () {
						$(`option[value="${user}"]`).remove();
						$('#debitors').show()
						select = $('#debitors').filterMultiSelect({ placeholderText: 'Select Debitors...' })

						var getJson = () => $.fn.filterMultiSelect.applied.map(e => JSON.parse(e.getSelectedOptionsAsJson(true))).reduce((p, c) => p.concat(c.debitor), [])
						$('#debitors').on('optionselected optiondeselected', function (e) {
							$('.t,.s').show()
							$('.t tfoot td:nth-child(2)').text('0')
							$('table tbody.distribute').replaceWith($('<tbody class="distribute">').append(getJson().map(e => $('<tr>').append($('<td>').text(lookup(e,2,0)), $('<td>').append($('<input type="number" min="0" value="default 0" step="10">'))))));
						})
						$(document).on('input', '.t input', function () {
							$('.t tfoot td:nth-child(2)').text($('.t tbody.distribute tr input').toArray().reduce((total, input) => total + (parseFloat($(input).val()) || 0), 0));
							if ($('.t tfoot td:nth-child(2)').text()=='0') $('.s').prop('disabled',true)
							else $('.s').prop('disabled',false)
						})
						$('.s').on('click', function () {
							$(this).prop('disabled', true)
							$('html').addClass('l')
							const rows = $('.distribute tr').map((_, el) => $(el).find('td').map((_, el) => $(el).find('input').val() || lookup($(el).text(),0,2)).get()).get();
							$('.payer').html(lookup(user,2,0))
							$('.titleOutput').html($('#titleInput').val())
							total = $('.t tfoot td:nth-child(2)').text()
							receiptRow = ''
							sender=[user]
							for (var i = 0; i < rows.length; i += 2) {
								console.log(Number(lookup(rows[i], 2, 1)))
								receiptRow += `<tr><td>${lookup(rows[i], 2, 0)}</td><td>${Number(lookup(rows[i], 2, 1)) - Number(rows[i + 1])}</td><td>(${rows[i + 1]<0 ? '-'+rows[i + 1]:Math.abs(rows[i + 1])})</td></tr>`
								sender.push(rows[i])
							}
							$('.reciept tbody').html(`<tr><td>${lookup(user, 2, 0)}</td><td>${Number(lookup(user, 2, 1)) + Number(total)}</td><td>(${total})</td></tr>${receiptRow}`)
							guests=rows.map((email, index)=>(index%2===0?lookup(email,2,0)+'('+rows[index+1]>0 ? rows[index+1] : Math.abs(rows[index+1])+')':'')).filter(Boolean).join(',');
							historyRecord=[moment().format('YYYY-MM-DD HH:mm:ss'),$('#titleInput').val(),lookup(user,2,0),guests,total];
							rows.splice(0, 0, user,  total > 0 ? '-' +total :total );
							google.script.run.withSuccessHandler(r => {
								google.script.run.withSuccessHandler(table => { $('.statement').html(table).promise().done(function () {
									$('.statement tbody tr').each(function () {if ($(this).find('td:nth-child(3)').text() === user) $(this).addClass('marked-row')})
									$('.statement th').each(function () { $(this).html($(this).html() + '<i class="material-icons" style="vertical-align: middle">unfold_more</i>') });})
								 }).grab('table')
								 $('.in').hide()
								 $('html').removeClass('l')
								 //$('.s').prop('disabled',false)

								 $('.out').show()
								$('.out').html(r + '<br><br>' + $('.reciept').html()+'<br><a id="refresh-all-scripts" style="text-decoration:underline;color: #0000EE;cursor:pointer;">< Back</a>')
								$('#refresh-all-scripts').on('click', function() {
									$('.in').show()
									$('.out').hide()
									$('#debitors').show()
									$('.reciept').hide()
									$('.t,.s').show()
									$('table tbody.distribute').html('')
									$('#titleInput').html('')
									$('.t tfoot td:nth-child(2)').text('0')
									$('#bal').html(lookup(user,2,1))
									select.deselectAll()
									
									});

									
								$('.reciept').show()
								
							}).update(rows, $('.reciept').html(),sender.join(','),historyRecord);

						});
					})
				
			})
		

		//google.script.run.withSuccessHandler(toString => {console.log('toString', toString)}).grab('toString')
	</script>
</body>

</html>